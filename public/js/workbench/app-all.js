/*
 * amun
 * A social content managment system based on the psx framework. For
 * the current version and informations visit <http://amun.phpsx.org>
 *
 * Copyright (c) 2010-2013 Christoph Kappestein <k42b3.x@gmail.com>
 *
 * This file is part of amun. amun is free software: you can
 * redistribute it and/or modify it under the terms of the
 * GNU General Public License as published by the Free Software
 * Foundation, either version 3 of the License, or any later version.
 *
 * amun is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with amun. If not, see <http://www.gnu.org/licenses/>.
*/
Ext.define("Amun.form.Editor",{extend:"Ext.form.field.Text",alias:"widget.aceeditor",editorId:null,editor:null,initComponent:function(){var b=this;b.editorId=Ext.id();var a={cls:"wb-content-form-editor",fieldSubTpl:['<div id="{id}" {inputAttrTpl}>','<div id="'+b.editorId+'" class="amun-ace-editor"></div>',"</div>",{disableFormats:true}]};Ext.apply(b,a);b.callParent()},afterRender:function(){var b=this;b.callParent(arguments);var a=Ext.select("#"+b.editorId);a.setWidth(this.getWidth());a.setHeight(this.getHeight());b.editor=ace.edit(b.editorId);b.editor.setTheme("ace/theme/eclipse");b.editor.setValue(b.rawValue,-1)},setRawValue:function(b){var a=this;a.rawValue=b;return b},getRawValue:function(){var a=this;var b=a.editor!=null?a.editor.getValue():"";return b}});Ext.define("Amun.form.Form",{extend:"Ext.window.Window",method:"POST",action:null,initComponent:function(){var b=this;b.addEvents("submit","reset","formLoaded");var a={title:"Form",closable:true,width:800,height:600,resizable:false,layout:"fit",items:[{layout:"fit",border:false,bodyStyle:"padding:5px;",html:"Loading ..."}]};Ext.apply(b,a);b.callParent();this.loadForm()},reload:function(){this.getForm().reset()},getPage:function(){return this.page},getRecordId:function(){return this.recordId},getMethod:function(){return this.method},getAction:function(){return this.action},getFormPanel:function(){return this.query("panel[cls=wb-content-form]")[0]},getForm:function(){return this.getFormPanel().getForm()},loadForm:function(){var a=null;if(this.type=="CREATE"){a=this.service.getUri()+"/form?method=create"}else{if(this.type=="UPDATE"){a=this.service.getUri()+"/form?method=update&id="+this.recordId}else{if(this.type=="DELETE"){a=this.service.getUri()+"/form?method=delete&id="+this.recordId}else{console.log("Invalid type")}}}if(a!=null){if(this.page){a=a+"&pageId="+this.page.id}Ext.Ajax.request({url:a,scope:this,success:function(c,d){var b=Ext.JSON.decode(c.responseText);this.doFormLoaded(b)},failure:function(b){Ext.Msg.alert("Error",b.responseText)}})}},doFormLoaded:function(a){this.remove(0);if(typeof(a.success)!="undefined"&&a.success==false){this.add({layout:"fit",border:false,bodyStyle:"padding:5px;",html:a.text})}else{this.add(this.buildForm(a))}this.doLayout();this.fireEvent("formLoaded",this)},buildForm:function(a){return Ext.create("Ext.panel.Panel",{layout:"fit",border:false,items:[this.parseElements(a)]})},buildChildren:function(c){var a=[];if(c.children&&c.children.item&&c.children.item.length>0){for(var b=0;b<c.children.item.length;b++){a.push(this.parseElements(c.children.item[b]))}}return a},parseElements:function(a){if(typeof(a.success)!="undefined"&&a.success==false){return{xtype:"label",text:a.text}}switch(a["class"]){case"form":return this.onForm(a);break;case"tabbedPane":return this.onTabPanel(a);break;case"panel":return this.onPanel(a);break;case"captcha":return this.onCaptcha(a);break;case"datalist":return this.onDatalist(a);break;case"reference":return this.onReference(a);break;case"input":return this.onInput(a);break;case"select":return this.onSelect(a);break;case"textarea":return this.onTextarea(a);break}},onForm:function(a){this.method=a.method;this.action=a.action;return Ext.create("Ext.form.Panel",{url:a.action,cls:"wb-content-form",items:[this.parseElements(a.item)],border:false,region:"center",fieldDefaults:{labelWidth:120,width:340},buttons:[{text:"Reset",scope:this,handler:function(){this.fireEvent("reset",this)}},{text:"Submit",formBind:true,disabled:true,scope:this,handler:function(){this.fireEvent("submit",this)}}]})},onTabPanel:function(a){return Ext.create("Ext.tab.Panel",{title:a.label,border:false,items:this.buildChildren(a)})},onPanel:function(a){return Ext.create("Ext.panel.Panel",{title:a.label,border:false,bodyPadding:5,items:this.buildChildren(a)})},onCaptcha:function(a){return null},onDatalist:function(a){return null},onReference:function(b){var a=Ext.create("Ext.data.Store",{fields:[b.valueField,b.labelField],autoLoad:true,proxy:{type:"ajax",url:b.src+"?fields="+b.valueField+","+b.labelField+"&format=json",reader:{type:"json",root:"entry",idProperty:"id",totalProperty:"totalResults"}}});return Ext.create("Ext.form.ComboBox",{name:b.ref,disabled:b.disabled,fieldLabel:b.label,store:a,value:b.value,queryMode:"remote",displayField:b.labelField,valueField:b.valueField})},onInput:function(b){switch(b.type){case"hidden":var a={xtype:"hiddenfield",name:b.ref,value:b.value,};break;case"date":case"datetime":case"datetime-local":var a={xtype:"datefield",name:b.ref,disabled:b.disabled,value:b.value,fieldLabel:b.label,format:"Y-m-d H:i:s"};break;case"file":var a={xtype:"filefield",name:b.ref,disabled:b.disabled,value:b.value,fieldLabel:b.label};break;case"number":var a={xtype:"numberfield",name:b.ref,disabled:b.disabled,value:b.value,fieldLabel:b.label};break;default:var a={xtype:"textfield",name:b.ref,disabled:b.disabled,value:b.value,fieldLabel:b.label,inputType:b.type=="password"?"password":"text"}}return a},onSelect:function(e){var d=null;var f=[];if(typeof e.children.item!="undefined"){for(var b=0;b<e.children.item.length;b++){var c=e.children.item[b];f.push({value:c.value,name:c.label});if(c.value==e.value){d=c.value}}}var a=Ext.create("Ext.data.Store",{fields:["value","name"],data:f});return Ext.create("Ext.form.ComboBox",{name:e.ref,disabled:e.disabled,fieldLabel:e.label,store:a,value:d,queryMode:"local",displayField:"name",valueField:"value"})},onTextarea:function(a){return{xtype:"aceeditor",width:640,height:300,grow:true,name:a.ref,fieldLabel:a.label,value:a.value,disabled:a.disabled}}});Ext.define("Amun.service.content.page.Form",{extend:"Amun.form.Form",formPanel:null,gadgetPanel:null,initComponent:function(){var a=this;a.callParent();a.on("formLoaded",function(b){b.gadgetPanel.getStore().load()})},reload:function(){this.getForm().reset();this.gadgetPanel.getStore().load()},buildForm:function(d){this.formPanel=this.parseElements(d);this.formPanel.add({xtype:"hiddenfield",cls:"wb-form-gadgets",name:"gadgets",value:""});this.gadgetPanel=null;var b=Amun.xrds.Manager.findServiceUri("http://ns.amun-project.org/2011/amun/service/content/gadget");if(b!==false){var a=Ext.create("Amun.service.content.page.GadgetStore",{autoLoad:false,proxy:{type:"ajax",url:b+"?count=1024&fields=id,name&format=json",reader:{type:"json",root:"entry",idProperty:"id",totalProperty:"totalResults"}}});a.on("load",function(e,f){e.getRootNode().expand();if(this.recordId>0){this.loadExistingGadgets()}},this);this.gadgetPanel=Ext.create("Ext.tree.Panel",{title:"Gadgets",region:"east",margins:"0 0 0 5",border:false,width:200,store:a,hideHeaders:true,useArrows:true,rootVisible:false,viewConfig:{plugins:{ptype:"treeviewdragdrop",containerScroll:true}},listeners:{scope:this,checkchange:function(f,e){this.updateGadgets()},itemmove:function(f,e){this.updateGadgets()}}})}var c={layout:"border",border:false,items:[this.formPanel,this.gadgetPanel]};c.formMethod=d.method;c.formAction=d.action;return c},loadExistingGadgets:function(){var a=Amun.xrds.Manager.findServiceUri("http://ns.amun-project.org/2011/amun/service/content/page/gadget");if(a!==false){Ext.Ajax.request({url:a+"?fields=id,gadgetId,sort&count=1024&sortBy=sort&sortOrder=ascending&filterBy=pageId&filterOp=equals&filterValue="+this.recordId+"&format=json",scope:this,success:function(c,f){var b=Ext.JSON.decode(c.responseText);if(b.entry.length>0){for(var d=0;d<b.entry.length;d++){var e=this.gadgetPanel.getStore().getNodeById(b.entry[d].gadgetId);if(e){e.set("checked",true);e.set("sort",b.entry[d].sort)}}this.gadgetPanel.getStore().sort("sort","ASC");this.updateGadgets()}},failure:function(b){Ext.Msg.alert("Error",b.responseText)}})}},updateGadgets:function(){var c="";var a=this.gadgetPanel.getStore().getRootNode();a.eachChild(function(d){if(d.get("checked")){c+=d.get("id")+","}},this);var b=this.query("hidden[cls=wb-form-gadgets]")[0];b.setValue(c)}});Ext.define("Amun.service.content.page.Gadget",{extend:"Ext.data.Model",fields:[{name:"id",type:"int"},{name:"text",type:"string",mapping:"name"},{name:"leaf",type:"boolean",defaultValue:true},{name:"sort",type:"int",defaultValue:0},{name:"checked",type:"boolean",defaultValue:false}]});Ext.define("Amun.service.content.page.Grid",{extend:"Ext.panel.Panel",tree:null,grid:null,initComponent:function(){var b=this;var a={layout:"border",border:false,items:[this.buildTree(),this.buildGrid()]};Ext.apply(b,a);b.callParent()},reload:function(){this.grid.reload()},buildTree:function(){Ext.Ajax.request({url:url+"api/page/tree?format=json",scope:this,success:function(b,c){var a=this.buildRecTree(JSON.parse(b.responseText));this.tree.setRootNode(a);this.tree.getRootNode().expand()}});this.tree=Ext.create("Ext.tree.Panel",{region:"west",margins:"0 5 0 0",header:false,border:false,width:200,viewConfig:{plugins:{ptype:"treeviewdragdrop",containerScroll:true},listeners:{beforedrop:function(b,d,c,a){return d.records.length==1&&a!="append"}}},hideHeaders:true,useArrows:true,rootVisible:true});this.tree.on("itemmove",function(a,j,k,g,h){var c=this.getStore().getNodeById(k.get("id"));if(c){var e=[];var f=0;c.eachChild(function(i){e.push({id:i.get("id"),sort:f});f++});if(e.length>0){var d={entry:e};var b=Amun.xrds.Manager.findServiceUri("http://ns.amun-project.org/2011/amun/service/content/page");Ext.Ajax.request({url:b+"/tree?format=json",method:"POST",headers:{"X-HTTP-Method-Override":"PUT",Accept:"application/json"},jsonData:d,scope:this,success:function(l,m){try{var i=Ext.JSON.decode(l.responseText);if(i.success==true){return}}catch(n){}this.getStore().load()},failure:function(i,l){this.getStore().load()}})}}});this.tree.on("select",function(a,b){var b=this.grid.getStore().getById(b.get("id"));this.grid.getSelectionModel().select([b])},this);return this.tree},buildRecTree:function(a){var c=[];if(a.children&&a.children.length>0){for(var b=0;b<a.children.length;b++){c.push(this.buildRecTree(a.children[b]))}}var d={text:a.title,id:a.id,cls:a.status==0?"wb-tree-page-normal":"wb-tree-page-hidden",leaf:true,children:null};if(c.length>0){d.leaf=false;d.children=c}return d},buildGrid:function(){this.grid=Ext.create("Amun.Grid",{border:false,region:"center",service:this.service,result:this.result,columnConfig:{id:80,path:200,title:100,template:100,serviceName:100,date:120,serviceType:100}});this.grid.on("reload",function(){this.tree.getStore().load()},this);this.grid.on("celldblclick",function(c){var e=this.grid.getSelectionModel().getSelection()[0];var a=Amun.xrds.Manager.findService(e.raw.serviceType);if(a){var b=null;var d="Amun."+a.getNamespace()+".Editor";if(Ext.ClassManager.get(d)!=null){b=Ext.create(d,{service:a,page:e.raw})}if(b==null){b=Ext.create("Amun.Editor",{service:a,page:e.raw})}b.show()}},this);return this.grid}});Ext.define("Amun.service.user.group.Form",{extend:"Amun.form.Form",initComponent:function(){var a=this;a.callParent();a.on("formLoaded",function(b){this.loadRights()});a.on("submit",function(c){var b=Ext.create("Ext.window.Window",{title:"Operation",height:60,width:280,modal:true,layout:"fit",items:[Ext.create("Ext.ProgressBar",{border:false,text:"Initialize ..."})]});b.show();b.getComponent(0).wait({interval:200,increment:15});var d=c.getForm();d.on("actioncomplete",function(e,f){b.hide()})},this)},reload:function(){this.getForm().reset();if(this.recordId>0){this.loadExistingRights()}},loadRights:function(){var a=Amun.xrds.Manager.findServiceUri("http://ns.amun-project.org/2011/amun/service/user/right");if(a!==false){Ext.Ajax.request({url:a+"?count=1024&fields=id,description&format=json",scope:this,success:function(e,g){var b=Ext.JSON.decode(e.responseText);if(b.entry.length>0){var d=[];for(var f=0;f<b.entry.length;f++){d.push({xtype:"checkbox",boxLabel:b.entry[f].description,itemId:"right_"+b.entry[f].id,name:"right_"+b.entry[f].id,inputValue:b.entry[f].id,width:200,scope:this,handler:function(){this.updateRights()}})}var c=[{xtype:"hiddenfield",cls:"wb-form-rights",name:"rights",value:""},{xtype:"checkboxgroup",fieldLabel:"Rights",columns:3,style:"margin-left:5px;",items:d}];this.getFormPanel().addBodyCls("wb-overflow");this.getFormPanel().add(c);this.doLayout();if(this.recordId>0){Ext.Function.defer(function(){this.loadExistingRights()},200,this)}}else{}},failure:function(b){Ext.Msg.alert("Error",b.responseText)}})}},loadExistingRights:function(){var a=Amun.xrds.Manager.findServiceUri("http://ns.amun-project.org/2011/amun/service/user/group/right");if(a!==false){Ext.Ajax.request({url:a+"?fields=id,rightId&count=1024&filterBy=groupId&filterOp=equals&filterValue="+this.recordId+"&format=json",scope:this,success:function(c,g){var b=Ext.JSON.decode(c.responseText);if(b.entry.length>0){var f=this.query("checkboxgroup")[0];for(var e=0;e<b.entry.length;e++){var d=f.getComponent("right_"+b.entry[e].rightId);if(d){d.setValue(true)}}this.updateRights()}},failure:function(b){Ext.Msg.alert("Error",b.responseText)}})}},updateRights:function(){var c="";var d=this.query("checkbox");for(var a=0;a<d.length;a++){if(d[a].getRawValue()){c+=d[a].getSubmitValue()+","}}var b=this.query("hidden[cls=wb-form-rights]")[0];b.setValue(c)}});Ext.define("Amun.service.mail.Form",{extend:"Amun.form.Form",initComponent:function(){var a=this;a.callParent();a.on("formLoaded",function(b){this.getFormPanel().addBodyCls("wb-overflow")})}});Ext.define("Amun.xrds.Manager",{singleton:true,services:[],discover:function(a){a=a||{};var c=this,b=a.scope||window;Ext.Ajax.request({url:psx_url,scope:this,success:function(d,f){var h=d.getResponseHeader("X-XRDS-Location");if(h!=""){var e=new Ext.data.XmlStore({proxy:{type:"ajax",url:h,reader:{type:"xml",root:"XRD",record:"Service"}},record:"Service",fields:["URI"]});e.load({scope:this,callback:function(j,i,k){this.services=this.parseRecords(j);Ext.callback(a.success,a.scope,[this.services])}})}else{var g="Could not find XRDS header";Ext.callback(a.failure,a.scope,[g])}},failure:function(d,e){var f="Could not request home url";Ext.callback(a.failure,a.scope,[f])}})},parseRecords:function(c){var b=[];for(var f=0;f<c.length;f++){var g=Ext.dom.Query.selectNode("URI:first",c[f].raw).textContent;var e=Ext.dom.Query.select("Type",c[f].raw);var a=[];for(var d=0;d<e.length;d++){a.push(e[d].textContent)}b.push(Ext.create("Amun.Service",{uri:g,types:a}))}console.log("Found "+b.length+" services");return b},getServices:function(){return this.services},findService:function(b){for(var a=0;a<this.services.length;a++){if(this.services[a].hasType(b)){return this.services[a]}}return false},findServiceUri:function(b){var a=this.findService(b);if(a!=false){return a.getUri()}return false}});Ext.define("Amun.Auth",{singleton:true,verify:function(a){a=a||{};var d=this,b=a.scope||window;var c=Amun.xrds.Manager.findServiceUri("http://ns.amun-project.org/2011/amun/service/my/verifyCredentials");if(c!=false){Ext.Ajax.request({url:c+"?format=json",success:function(g,h){var i=Ext.JSON.decode(g.responseText);var f=Ext.create("Amun.User",i);Ext.callback(a.success,a.scope,[f])},failure:function(f,g){var h="Could not find verifyCredentials service";Ext.callback(a.failure,a.scope,[h])}})}else{var e="Could not find verifyCredentials service";Ext.callback(a.failure,a.scope,[e])}}});Ext.define("Amun.Application",{user:null,services:null,constructor:function(a){a=a||{};Ext.apply(this,a)},start:function(){Amun.xrds.Manager.discover({scope:this,success:this.onServiceDiscovered,failure:function(a){console.log(a)}})},onServiceDiscovered:function(a){this.services=a;Amun.Auth.verify({scope:this,success:this.onAuthentication,failure:function(b){console.log(b)}})},onAuthentication:function(b){this.user=b;if(b.loggedIn==true&&b.status=="Administrator"){var a=Ext.create("Ext.container.Viewport",{layout:"border",items:[{region:"north",title:'<div class="wb-header"><div style="float:left;">Workbench (<a href="'+psx_url+'">'+psx_url+'</a>)</div><div style="float:right;">Logged in as: <a href="'+b.profileUrl+'">'+b.name+'</a><img src="'+b.thumbnailUrl+'" width="16" style="float:right;margin-left:4px" /></div></div>',margins:"0 0 0 0",border:false},{region:"west",layout:"fit",width:200,minWidth:175,maxWidth:400,margins:"5 5 5 5",items:[{header:false,xtype:"navigation"}]},{region:"center",layout:"fit",margins:"5 5 5 0",items:[{header:false,xtype:"content"}]}]})}else{Ext.Msg.alert("Information",'Please <a href="'+psx_url+'">login</a> with an administrator account',function(){window.location=psx_url})}}});Ext.define("Amun.ColumnConfig",{singleton:true,getByService:function(a){if(a.hasType("http://ns.amun-project.org/2011/amun/service/content/gadget")){return{id:80,name:300,title:300,date:120}}else{if(a.hasType("http://ns.amun-project.org/2011/amun/service/media")){return{id:80,name:300,mimeType:200,size:100,date:120}}else{if(a.hasType("http://ns.amun-project.org/2011/amun/service/user/account")){return{id:80,name:300,email:200,countryTitle:100,date:120}}else{if(a.hasType("http://ns.amun-project.org/2011/amun/service/user/activity")){return{id:80,authorName:100,verb:100,summary:400,date:120}}else{if(a.hasType("http://ns.amun-project.org/2011/amun/service/core/service")){return{id:80,name:200,source:200,license:100,version:100,date:120}}else{if(a.hasType("http://ns.amun-project.org/2011/amun/service/mail")){return{id:80,name:200,from:200,subject:320}}else{if(a.hasType("http://ns.amun-project.org/2011/amun/service/oauth")){return{id:80,status:80,name:120,email:120,url:280,date:120}}else{if(a.hasType("http://ns.amun-project.org/2011/amun/service/country")){return{id:80,title:360,code:120,longitude:120,latitude:120}}else{if(a.hasType("http://ns.amun-project.org/2011/amun/service/comment")){return{id:80,authorName:120,pageTitle:120,text:360,date:120}}else{if(a.hasType("http://ns.amun-project.org/2011/amun/service/file")){return{id:80,pageTitle:120,contentType:120,content:360,date:120}}else{if(a.hasType("http://ns.amun-project.org/2011/amun/service/forum")){return{id:80,authorName:120,pageTitle:120,title:360,date:120}}else{if(a.hasType("http://ns.amun-project.org/2011/amun/service/news")){return{id:80,authorName:120,pageTitle:120,title:360,date:120}}else{if(a.hasType("http://ns.amun-project.org/2011/amun/service/page")){return{id:80,authorName:120,pageTitle:120,content:360,date:120}}else{if(a.hasType("http://ns.amun-project.org/2011/amun/service/php")){return{id:80,authorName:120,pageTitle:120,content:360,date:120}}else{if(a.hasType("http://ns.amun-project.org/2011/amun/service/phpinfo")){return{key:400,value:400}}else{if(a.hasType("http://ns.amun-project.org/2011/amun/service/pipe")){return{id:80,authorName:120,pageTitle:120,mediaName:360,date:120}}else{if(a.hasType("http://ns.amun-project.org/2011/amun/service/redirect")){return{id:80,authorName:120,pageTitle:120,href:360,date:120}}}}}}}}}}}}}}}}}}return false}});Ext.define("Amun.Editor",{extend:"Ext.window.Window",initComponent:function(){var b=this;var a={title:"Editor",closable:true,width:820,height:600,resizable:false,layout:"fit",items:[this.buildContainer()]};Ext.apply(b,a);b.callParent()},buildContainer:function(){var d;var e="Amun."+this.service.getNamespace()+".Grid";var c=Ext.ClassManager.get(e);var b={title:this.service.getName(),closable:true,service:this.service,page:this.page};if(c!=null){d=Ext.create(e,b)}else{d=Ext.create("Amun.Grid",b);var a=d.getStore();a.getProxy().setExtraParam("filterBy","pageId");a.getProxy().setExtraParam("filterOp","equals");a.getProxy().setExtraParam("filterValue",this.page.id)}return d}});Ext.define("Amun.service.phpinfo.Store",{extend:"Ext.data.Store",groupField:"group"});Ext.define("Amun.Grid",{extend:"Ext.grid.Panel",service:null,result:null,selectedRecordId:null,columnConfig:false,columns:null,searchColumns:null,store:null,initComponent:function(){var b=this;b.addEvents("reload");var a=this.buildGrid(this.service,this.result);Ext.apply(b,a);b.callParent()},reload:function(){this.getStore().load()},buildGrid:function(b,a){this.buildColumns(a);this.store=this.buildStore(b);return{store:this.store,columns:this.columns,border:false,cls:"wb-content-grid",selModel:{listeners:{scope:this,selectionchange:this.onSelect}},listeners:{scope:this,celldblclick:this.onDblClick},tbar:this.getTbar(),bbar:this.getBbar()}},buildColumns:function(a){this.columns=[];this.searchColumns=[];var c=this.getColumnConfig();if(typeof c=="object"){for(var b in c){this.columns.push({text:b,width:c[b],dataIndex:b});this.searchColumns.push(b)}}else{for(var d=0;d<a.length;d++){this.columns.push({text:a[d],dataIndex:a[d]});this.searchColumns.push(a[d])}}return fields},buildStore:function(b){var c="Amun."+b.getNamespace()+".Model";if(Ext.ClassManager.get(c)==null){var a=[];for(var e=0;e<this.columns.length;e++){a.push({name:this.columns[e].text,type:"string"})}Ext.define(c,{extend:"Ext.data.Model",fields:a,idProperty:"id"})}var a="";for(var e=0;e<this.searchColumns.length;e++){a+=this.searchColumns[e]+","}var d="Amun."+b.getNamespace()+".Store";if(Ext.ClassManager.get(d)==null){d="Ext.data.Store"}return Ext.create(d,{model:c,autoLoad:true,remoteSort:true,remoteFilter:true,pageSize:32,proxy:{type:"ajax",url:b.getUri(),filterParam:"filterValue",limitParam:"count",pageParam:null,sortParam:"sortBy",directionParam:"sortOrder",startParam:"startIndex",extraParams:{fields:a},simpleSortMode:true,reader:{type:"json",root:"entry",idProperty:"id",totalProperty:"totalResults"}}})},showForm:function(c,a,e){var d=null;var b="Amun."+a.getNamespace()+".Form";if(Ext.ClassManager.get(b)!=null){d=Ext.create(b,{type:c,service:a,page:e,recordId:this.getSelectedRecordId()})}if(d==null){d=Ext.create("Amun.form.Form",{type:c,service:a,page:e,recordId:this.getSelectedRecordId()})}d.on("submit",function(f){var g=f.getForm();if(g.isValid()){var h="";if(g.hasUpload()){h="?format=json&htmlMime=1"}g.submit({url:f.getAction()+h,method:"POST",headers:{"X-HTTP-Method-Override":f.getMethod(),Accept:"application/json"},success:function(i,j){Ext.Msg.alert("Success",j.result.text,function(){this.reload();this.fireEvent("reload")},this)},failure:function(i,j){Ext.Msg.alert("Failed",j.result.text)},scope:this})}},this);d.on("reset",function(f){var g=f.getForm();g.reset()},this);d.show()},getSelectedRecordId:function(){return this.selectedRecordId},getTbar:function(){return[{text:"Add Record",iconCls:"wb-icon-add",cls:"wb-content-add",scope:this,handler:this.onAddClick},{text:"Edit Record",iconCls:"wb-icon-edit",cls:"wb-content-edit",disabled:true,scope:this,handler:this.onEditClick},{text:"Delete Record",iconCls:"wb-icon-delete",cls:"wb-content-delete",disabled:true,scope:this,handler:this.onDeleteClick},"->",{xtype:"combobox",cls:"wb-content-search-filterBy",width:100,store:this.searchColumns,value:this.searchColumns.slice(0),editable:false},{xtype:"combobox",cls:"wb-content-search-filterOp",width:85,store:["contains","equals","startsWith","present"],value:"contains",editable:false},{xtype:"textfield",cls:"wb-content-search-filterValue",listeners:{scope:this,specialkey:this.onSearchEnter}},{text:"Search",iconCls:"wb-icon-search",scope:this,handler:this.onSearchClick}]},getBbar:function(){return Ext.create("Ext.PagingToolbar",{store:this.store,displayInfo:true,displayMsg:"Displaying record {0} - {1} of {2}",emptyMsg:"No records to display",})},onSelect:function(a){if(this.getSelectionModel().hasSelection()){var b=this.getSelectionModel().getSelection()[0];if(this.query("button[cls=wb-content-edit]").length>0){this.query("button[cls=wb-content-edit]")[0].enable()}if(this.query("button[cls=wb-content-delete]").length>0){this.query("button[cls=wb-content-delete]")[0].enable()}this.selectedRecordId=b.get("id")}else{if(this.query("button[cls=wb-content-edit]").length>0){this.query("button[cls=wb-content-edit]")[0].disable()}if(this.query("button[cls=wb-content-delete]").length>0){this.query("button[cls=wb-content-delete]")[0].disable()}this.selectedRecordId=null}},onDblClick:function(a){},onAddClick:function(b,c,a){this.showForm("CREATE",this.service,this.page)},onEditClick:function(b,c,a){this.showForm("UPDATE",this.service,this.page)},onDeleteClick:function(b,c,a){this.showForm("DELETE",this.service,this.page)},onSearchClick:function(e){var d=e.findParentByType("grid");var a=d.query("combo[cls=wb-content-search-filterBy]")[0].getValue();var c=d.query("combo[cls=wb-content-search-filterOp]")[0].getValue();var f=d.query("textfield[cls=wb-content-search-filterValue]")[0].getValue();var b=d.getStore();b.getProxy().setExtraParam("filterBy",a);b.getProxy().setExtraParam("filterOp",c);b.getProxy().setExtraParam("filterValue",f);b.load()},onSearchEnter:function(a,b){if(b.getKey()==b.ENTER){this.onSearchClick(a)}},getColumnConfig:function(){if(this.columnConfig===false){return Amun.ColumnConfig.getByService(this.service)}else{return this.columnConfig}}});Ext.define("Amun.SplitEditor",{extend:"Amun.Editor",record:null,initComponent:function(){var b=this;var a={maximized:true};Ext.apply(b,a);b.callParent();b.on("boxready",function(){var c=Ext.select(".amun-ace-editor");if(c){c.setWidth(this.getEditorComponent().getWidth());c.setHeight(this.getEditorComponent().getHeight())}this.getEditorComponent().on("resize",function(h,g,d,e,j,f){var i=Ext.select(".amun-ace-editor");if(i){i.setWidth(g);i.setHeight(d)}});b.requestPage()})},buildContainer:function(){return Ext.create("Ext.panel.Panel",{border:false,layout:"border",bbar:this.getBbar(),items:[{region:"west",layout:"fit",width:"50%",border:false,split:true,minWidth:200,collapsible:true,collapseMode:"mini",preventHeader:true,items:[this.getEditorPanel()]},{region:"center",layout:"fit",width:"50%",border:false,items:[{xtype:"component",autoEl:{tag:"iframe",cls:"wb-iframe-preview",src:url+this.page.path}}]}]})},reloadPreview:function(){if(frames[0]){frames[0].location.reload()}},setEditorValue:function(b){var a=this.query("aceeditor");if(a[0]){a[0].editor.setValue(b,-1)}},getEditorValue:function(){var a=this.query("aceeditor");if(a[0]){return a[0].editor.getValue()}return""},getEditorComponent:function(){return this.getComponent(0).getComponent(0)},getEditorPanel:function(){return{xtype:"aceeditor",grow:true,name:"content",value:""}},submitPage:function(b,a){Ext.Ajax.request({url:this.service.getUri()+"?format=json",scope:this,headers:{"X-HTTP-Method-Override":b},params:a,success:function(d,e){var c=Ext.JSON.decode(d.responseText);if(c.success){Ext.Msg.alert("Success",c.text);if(!this.record){this.requestPage()}this.reloadPreview()}else{Ext.Msg.alert("Error",c.text?c.text:"Unknown error occured")}},failure:function(c){Ext.Msg.alert("Error",c.responseText)}})},getBbar:function(){return[]},requestPage:function(){}});Ext.define("Amun.service.page.Editor",{extend:"Amun.SplitEditor",getBbar:function(){return[{text:"Preview",scope:this,handler:function(){if(frames[0]){var a=frames[0].document.querySelector(".amun-service-page-content");if(a){a.innerHTML=this.getEditorValue()}}}},{text:"Publish",scope:this,handler:function(){this.savePage()}}]},requestPage:function(){Ext.Ajax.request({url:this.service.getUri()+"?fields=id,content&count=1&filterBy=pageId&filterOp=equals&filterValue="+this.page.id+"&format=json",scope:this,success:function(b,c){var a=Ext.JSON.decode(b.responseText);if(a.entry[0]){this.record=a.entry[0];this.setEditorValue(this.record.content)}},failure:function(a){Ext.Msg.alert("Error",a.responseText)}})},savePage:function(){var b;var a;if(this.record){b="PUT";a={id:this.record.id,content:this.getEditorValue()}}else{b="POST";a={pageId:this.page.id,content:this.getEditorValue()}}this.submitPage(b,a)}});Ext.define("Amun.Service",{uri:null,types:null,constructor:function(a){a=a||{};Ext.apply(this,a)},hasType:function(b){for(var a=0;a<this.types.length;a++){if(this.types[a]==b){return true}}return false},hasTypeStartsWith:function(b){for(var a=0;a<this.types.length;a++){if(this.types[a].substr(0,b.length)==b){return this.types[a]}}return false},getFirstType:function(){var b=null;for(var a=0;a<this.types.length;a++){if(this.types[a]!="http://ns.amun-project.org/2011/amun/data/1.0"){b=this.types[a]}}return b},getTypes:function(){return this.types},getUri:function(){return this.uri},getName:function(){var a;var b=this.uri.lastIndexOf("/");a=this.uri.substr(b+1);a=a.charAt(0).toUpperCase()+a.substr(1);return a},getNamespace:function(){var a=this.getFirstType().substring(37);a=a.replace(/\//g,".");return a}});Ext.define("Amun.User",{name:null,thumbnailUrl:null,constructor:function(a){a=a||{};Ext.apply(this,a)}});Ext.define("Workbench.model.NavigationEntry",{extend:"Ext.data.Model",fields:[{name:"title",type:"string"},{name:"type",type:"string"}]});Ext.define("Workbench.view.Navigation",{extend:"Ext.panel.Panel",alias:"widget.navigation",title:"Navigation",border:0,cls:"wb-nav",layout:"accordion",items:[]});Ext.define("Workbench.view.Content",{extend:"Ext.tab.Panel",alias:"widget.content",title:"Content",border:false,cls:"wb-content",minTabWidth:64,items:[],initComponent:function(){this.callParent(arguments)}});Ext.define("Amun.service.content.page.GadgetStore",{extend:"Ext.data.TreeStore",model:"Amun.service.content.page.Gadget",root:{text:"Gadgets",id:null,leaf:false}});Ext.define("Amun.service.core.registry.Grid",{extend:"Amun.Grid",getTbar:function(){return[{text:"Edit Record",iconCls:"wb-icon-edit",cls:"wb-content-edit",disabled:true,scope:this,handler:this.onEditClick},"->",{xtype:"combobox",cls:"wb-content-search-filterBy",width:100,store:this.searchColumns,value:this.searchColumns.slice(0),editable:false},{xtype:"combobox",cls:"wb-content-search-filterOp",width:85,store:["contains","equals","startsWith","present"],value:"contains",editable:false},{xtype:"textfield",cls:"wb-content-search-filterValue",listeners:{scope:this,specialkey:this.onSearchEnter}},{text:"Search",iconCls:"wb-icon-search",scope:this,handler:this.onSearchClick}]}});Ext.define("Amun.service.core.service.Grid",{extend:"Amun.Grid",getTbar:function(){return[{text:"Delete Record",iconCls:"wb-icon-delete",cls:"wb-content-delete",disabled:true,scope:this,handler:this.onDeleteClick},"->",{xtype:"combobox",cls:"wb-content-search-filterBy",width:100,store:this.searchColumns,value:this.searchColumns.slice(0),editable:false},{xtype:"combobox",cls:"wb-content-search-filterOp",width:85,store:["contains","equals","startsWith","present"],value:"contains",editable:false},{xtype:"textfield",cls:"wb-content-search-filterValue",listeners:{scope:this,specialkey:this.onSearchEnter}},{text:"Search",iconCls:"wb-icon-search",scope:this,handler:this.onSearchClick}]},onDeleteClick:function(c,d,b){var a=c.findParentByType("grid");var f=a.getSelectionModel().getSelection()[0];Ext.Msg.confirm("Confirmation","Do you want uninstall the service?",function(e){if(e=="yes"){Ext.Ajax.request({url:this.service.getUri()+"?format=json",method:"POST",headers:{"X-HTTP-Method-Override":"DELETE",Accept:"application/json"},params:{id:this.selectedRecordId},scope:this,success:function(g,h){var i=Ext.JSON.decode(g.responseText);if(i&&i.success==true){Ext.Msg.alert("Success",i.text,function(){location.reload()},this)}else{Ext.Msg.alert("Failed",i.text?i.text:"Unknown error occured")}},failure:function(g,h){Ext.Msg.alert("Failed","Could not download service")}});return true}},this)}});Ext.define("Amun.service.file.Editor",{extend:"Amun.SplitEditor",getEditorComponent:function(){return this.getComponent(0).getComponent(0).getComponent(0).getComponent(1)},getEditorPanel:function(){var a=Ext.create("Ext.data.Store",{fields:["type"],data:[{type:"application/json"},{type:"application/xhtml+xml"},{type:"application/xml"},{type:"text/css"},{type:"text/html"},{type:"text/javascript"},{type:"text/plain"},{type:"text/xml"}]});return{border:false,layout:{type:"vbox",align:"stretch",pack:"start"},items:[{xtype:"combobox",store:a,queryMode:"local",displayField:"type",valueField:"type",value:"text/plain",editable:false},{xtype:"aceeditor",flex:1,grow:true,name:"content",value:""}]}},getBbar:function(){return[{text:"Save",scope:this,handler:function(){this.savePage()}}]},requestPage:function(){Ext.Ajax.request({url:this.service.getUri()+"?fields=id,content&count=1&filterBy=pageId&filterOp=equals&filterValue="+this.page.id+"&format=json",scope:this,success:function(b,c){var a=Ext.JSON.decode(b.responseText);if(a.entry[0]){this.record=a.entry[0];this.setEditorValue(this.record.content)}},failure:function(a){Ext.Msg.alert("Error",a.responseText)}})},savePage:function(){var c=this.down("combobox");var b;var a;if(this.record){b="PUT";a={id:this.record.id,contentType:c.getSubmitValue(),content:this.getEditorValue()}}else{b="POST";a={pageId:this.page.id,contentType:c.getSubmitValue(),content:this.getEditorValue()}}this.submitPage(b,a)}});Ext.define("Amun.service.user.group.Grid",{extend:"Amun.Grid",columnConfig:{id:80,title:600,date:120}});Ext.define("Amun.service.mail.Grid",{extend:"Amun.Grid",getTbar:function(){return[{text:"Add Record",iconCls:"wb-icon-add",cls:"wb-content-add",scope:this,handler:this.onAddClick},{text:"Edit Record",iconCls:"wb-icon-edit",cls:"wb-content-edit",disabled:true,scope:this,handler:this.onEditClick},"->",{xtype:"combobox",cls:"wb-content-search-filterBy",width:100,store:this.searchColumns,value:this.searchColumns.slice(0),editable:false},{xtype:"combobox",cls:"wb-content-search-filterOp",width:85,store:["contains","equals","startsWith","present"],value:"contains",editable:false},{xtype:"textfield",cls:"wb-content-search-filterValue",listeners:{scope:this,specialkey:this.onSearchEnter}},{text:"Search",iconCls:"wb-icon-search",scope:this,handler:this.onSearchClick}]}});Ext.define("Amun.service.phpinfo.Grid",{extend:"Amun.Grid",requires:["Ext.grid.feature.Grouping"],features:[{ftype:"grouping",groupHeaderTpl:"{name} ({rows.length})",hideGroupedHeader:true,startCollapsed:true}],getTbar:function(){return["->",{xtype:"combobox",cls:"wb-content-search-filterBy",width:100,store:this.searchColumns,value:this.searchColumns.slice(0),editable:false},{xtype:"combobox",cls:"wb-content-search-filterOp",width:85,store:["contains","equals","startsWith","present"],value:"contains",editable:false},{xtype:"textfield",cls:"wb-content-search-filterValue",listeners:{scope:this,specialkey:this.onSearchEnter}},{text:"Search",iconCls:"wb-icon-search",scope:this,handler:this.onSearchClick}]}});Ext.define("Workbench.controller.Content",{extend:"Ext.app.Controller",views:["Content"],refs:[{selector:"panel[cls=wb-content]",ref:"gridContainer"}],selectedService:null,statics:{recordId:null},init:function(){this.application.on({navclick:this.loadGrid,scope:this});this.control({"panel[cls=wb-content]":{render:this.onPanelRendered},})},onPanelRendered:function(){this.loadGrid("http://ns.amun-project.org/2011/amun/service/content/page")},getSelectedService:function(){return this.selectedService},getActiveTab:function(){return this.getGridContainer().getActiveTab()},loadGrid:function(c){var a=Amun.xrds.Manager.findService(c);if(a!=false){this.selectedService=a;var b=this.getGridContainer().getComponent(a.getUri());if(b==undefined){Ext.Ajax.request({url:a.getUri()+"/@supportedFields?format=json",scope:this,success:function(e,f){var d=Ext.JSON.decode(e.responseText);fields=d.item;this.buildGrid(a,fields)},failure:function(d){Ext.Msg.alert("Error",d.responseText)}})}else{this.getGridContainer().setActiveTab(b);b.reload()}}else{console.log("Unknown service "+c)}},buildGrid:function(b,a){var e;var f="Amun."+this.getSelectedService().getNamespace()+".Grid";var d=Ext.ClassManager.get(f);var c={itemId:b.getUri(),title:b.getName(),closable:true,service:b,result:a};if(d!=null){e=Ext.create(f,c)}else{e=Ext.create("Amun.Grid",c)}this.getGridContainer().add(e);this.getGridContainer().setActiveTab(e)}});Ext.define("Workbench.controller.Navigation",{extend:"Ext.app.Controller",views:["Navigation"],refs:[{selector:"panel[cls=wb-nav]",ref:"navContainer"}],models:["NavigationEntry"],controllers:["Content"],init:function(){this.control({"dataview[cls=wb-navigation]":{itemclick:this.onLinkClick},"panel[cls=wb-nav]":{render:this.onPanelRendered}})},onLinkClick:function(b,d,c,a){this.application.fireEvent("navclick",d.get("type"))},onPanelRendered:function(){this.buildNavigation()},buildNavigation:function(){this.addNavItems("Content",[{title:"Page",type:"http://ns.amun-project.org/2011/amun/service/content/page"},{title:"Gadget",type:"http://ns.amun-project.org/2011/amun/service/content/gadget"},{title:"Media",type:"http://ns.amun-project.org/2011/amun/service/media"}]);this.addNavItems("User",[{title:"Account",type:"http://ns.amun-project.org/2011/amun/service/user/account"},{title:"Group",type:"http://ns.amun-project.org/2011/amun/service/user/group"},{title:"Activity",type:"http://ns.amun-project.org/2011/amun/service/user/activity"}]);this.addNavItems("System",[{title:"Service",type:"http://ns.amun-project.org/2011/amun/service/core/service"},{title:"Registry",type:"http://ns.amun-project.org/2011/amun/service/core/registry"},{title:"Mail",type:"http://ns.amun-project.org/2011/amun/service/mail"},{title:"Oauth",type:"http://ns.amun-project.org/2011/amun/service/oauth"},{title:"Country",type:"http://ns.amun-project.org/2011/amun/service/country"},{title:"Phpinfo",type:"http://ns.amun-project.org/2011/amun/service/phpinfo"}])},addNavItems:function(d,g){var f=Amun.xrds.Manager.getServices();var h=[];for(var c=0;c<g.length;c++){for(var e=0;e<f.length;e++){if(f[e].hasType(g[c].type)){h.push({title:g[c].title,type:g[c].type})}}}var a=Ext.create("Ext.view.View",{store:Ext.create("Ext.data.Store",{model:"Workbench.model.NavigationEntry",data:h}),trackOver:true,cls:"wb-navigation",itemSelector:"div.wb-navigation-item",overItemCls:"wb-navigation-item-hover",tpl:'<tpl for="."><div class="wb-navigation-item">{title}</div></tpl>'});var b=Ext.create("Ext.Panel",{title:d,iconCls:"wb-icon-"+d.toLowerCase(),items:[a]});this.getNavContainer().add(b)}});Ext.Loader.setConfig({enabled:true,paths:{Amun:base_url+"/js/workbench/src/amun"}});Ext.require("Amun.form.Editor");Ext.require("Amun.form.Form");Ext.require("Amun.service.content.page.Form");Ext.require("Amun.service.content.page.GadgetStore");Ext.require("Amun.service.content.page.Gadget");Ext.require("Amun.service.content.page.Grid");Ext.require("Amun.service.core.registry.Grid");Ext.require("Amun.service.core.service.Grid");Ext.require("Amun.service.user.group.Form");Ext.require("Amun.service.user.group.Grid");Ext.require("Amun.service.file.Editor");Ext.require("Amun.service.mail.Form");Ext.require("Amun.service.mail.Grid");Ext.require("Amun.service.page.Editor");Ext.require("Amun.service.phpinfo.Grid");Ext.require("Amun.service.phpinfo.Store");Ext.require("Amun.xrds.Manager");Ext.require("Amun.Application");Ext.require("Amun.Auth");Ext.require("Amun.ColumnConfig");Ext.require("Amun.Editor");Ext.require("Amun.Grid");Ext.require("Amun.Service");Ext.require("Amun.SplitEditor");Ext.require("Amun.User");Ext.application({name:"Workbench",appFolder:base_url+"/js/workbench/app",controllers:["Navigation","Content"],launch:function(){var a=Ext.create("Amun.Application");a.start()}});
